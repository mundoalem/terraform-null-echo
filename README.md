<div align="center">

<img src="https://www.terraform.io/assets/images/logo-text-8c3ba8a6.svg" width="320px" />

# Template Terraform Module

![Release Version](https://img.shields.io/github/v/release/mundoalem/template-terraform-module)
![Pipeline Status](https://github.com/mundoalem/template-terraform-module/actions/workflows/pipeline.yml/badge.svg)
![Contributors](https://img.shields.io/github/contributors/mundoalem/template-terraform-module)

A DevOps centric template to bootstrap Terraform modules.

</div>

## Introduction

This project is a template anyone can use in order to bootstrap a Terraform module project. The template has a full feature pipeline following the latest DevOps practices.

The directory structure is inspired by projects such as [Terragrunt](https://github.com/gruntwork-io/terragrunt) and
[Terraspace](https://github.com/boltops-tools/terraspace).

You can control the project through the use of [mage](https://magefile.org/), it accepts
the following targets:

| Argument | Description                                                                     |
| -------- | ------------------------------------------------------------------------------- |
| build    | Runs `terraform init` and `terraform plan` saving the plan in `build` directory |
| clean    | Removes the files and directories generated by the build step                   |
| lint     | Runs `terraform fmt` for `modules` and `examples` directories                   |
| release  | Runs `terraform apply` from inside the `examples`dir                            |
| reset    | Does the same as the `clear` target plus removes `vendor` directory             |
| scan     | Runs `tfsec` to scan the code for unsafe patterns                               |
| test     | Runs all tests in `test` directory using `terratest`                            |

## License

[GPLv3](https://choosealicense.com/licenses/gpl-3.0/)

## Tech Stack

These are the software baked in this template:

- [Terraform](https://www.terraform.io/) v1.0.6
- [Go](https://www.python.org/) v1.17.0
- [Magefile](https://github.com/magefile/mage) v1.11.0
- [tfenv](https://github.com/tfutils/tfenv) v2.2.2
- [tfsec](https://github.com/aquasecurity/tfsec) v0.58.6

## Usage

In order to use this template you first need to clone this repo locally:

```
$ git clone git@github.com:mundoalem/template-terraform-module.git
$ mv template-terraform-module/ my-project-name/
$ cd my-project-name/
```

After you finish cloning the template you can start using it right away, however it may be better to make the project
your own by:

- Set your preferred Terraform version in `.terraform-version`.
- Add your license to the `LICENSE` file.
- Update the license header in all Terraform and Go files.
- Update the README.md with your project information.

Then install all dependencies by running:

```
$ go mod vendor
```

Last but not least, all pipeline jobs can be also run locally by invoking `mage`, example:

```bash
$ mage lint
$ mage test
$ mage scan
$ mage build
$ mage release
```

In order to release a package you can just create a release in GitHub with a tag, the pipeline will then start and at
the end of the release step it will attach the package tarballs to the release.

## Environment Variables

No environment variables are mandatory to run the pipeline, unless you require authentication to providers such as AWS
and Azure. In those cases, you need to provide the necessary secrets as environment variables, this way `terraform` can
read them.

In the pipeline the build script also looks into a few environment variables that are set by GitHub automatically. These
variables are used by the automation in order to either make decisions or use as input data:

| Variable   | Description                                                           |
| ---------- | --------------------------------------------------------------------- |
| CI         | Used to determine whether we are running locally or inside a pipeline |

## Feedback

If you have any feedback, please open an [issue](https://github.com/mundoalem/template-terraform-module/issues).

## Contributing

Please contribute to this repository if any of the following is true:

- You have expertise in community development, communication, or education
- You want open source communities to be more collaborative and inclusive
- You want to help lower the burden to first time contributors

The Prerequisites to contribute:

- Familiarity with [pull requests](https://help.github.com/articles/using-pull-requests) and [issues](https://guides.github.com/features/issues/).
- Knowledge of [Markdown](https://help.github.com/articles/markdown-basics/) for editing .md documents.
- Knowledge of [Go](https://golang.org/) and its ecosystem.
- Knowledge of [Terraform](https://www.terraform.io/) and its ecosystem.

In particular, this community seeks the following types of contributions:

- Ideas: participate in an issue thread or start your own to have your voice heard.
- Resources: submit a pull request to add to RESOURCES.md with links to related content.
- Outline sections: help us ensure that this repository is comprehensive. if there is a topic
  that is overlooked, please add it, even if it is just a stub in the form of a header and
  single sentence. Initially, most things fall into this category.
- Writing: contribute your expertise in an area by helping us expand the included content.
- Copy editing: fix typos, clarify language, and generally improve the quality of the content.
- Formatting: help keep content easy to read with consistent formatting.
- Features: add new features to the project.
- Bugfixes: fix open issues.

## Conduct

We are committed to providing a friendly, safe and welcoming environment for all, regardless of
gender, sexual orientation, disability, ethnicity, religion, income or similar personal
characteristic.

Please be kind and courteous. There's no need to be mean or rude. Respect that people have
differences of opinion and that every design or implementation choice carries a trade-off and
numerous costs. There is seldom a right answer, merely an optimal answer given a set of values
and circumstances.

Please keep unstructured critique to a minimum. If you have solid ideas you want to experiment
with, make a fork and see how it works.

We will exclude you from interaction if you insult, demean or harass anyone. That is not welcome
behavior. We interpret the term "harassment" as including the definition in the
[Citizen Code](http://citizencodeofconduct.org/) of Conduct; if you have any lack of clarity
about what might be included in that concept, please read their definition. In particular,
we don't tolerate behavior that excludes people in socially marginalized groups.

Whether you're a regular contributor or a newcomer, we care about making this community a safe
place for you and we've got your back.

Likewise any spamming, trolling, flaming, baiting or other attention-stealing behavior is not
welcome.

## Communication

GitHub issues are the primary way for communicating about specific proposed changes to this project.

In both contexts, please follow the conduct guidelines above. Language issues are often contentious and we'd like to
keep discussion brief, civil and focused on what we're actually doing, not wandering off into too much imaginary stuff.

## FAQ

### Will there ever be support for other continuous integration platforms?

Right now I have no plans to support other platforms like TravisCI, CircleCI or
Gitlab. Anyway, it should be quite easy for you to port the GitHub Actions to
any platform you like.

The reason for that is that I don't want to have a `.travis.yml`, a
`circleci.yml` and a `.gitlab-ci.yml` all together in the same place when only
one would actually be used. So I want to avoid (for now) cluttering the
template with too many files that might or might not be useful.

### Why don't you save the plan as a pipeline artifact so you don't run `terraform plan` twice?

As Hashicorp's itself states in their [documentation](https://bit.ly/3kVCHH7) page:

> The plan file contains a full copy of the configuration, the state that the plan applies to, and any variables passed
> to terraform plan. If any of these contain sensitive data then the archived working directory containing the plan file
> should be protected accordingly. For provider authentication credentials, it is recommended to use environment
> variables instead where possible since these are not included in the plan or persisted to disk by Terraform in any
> other way.

Therefore, since this is a public repository the best I can do to avoid people leaking their credentials by exposing
their plan files publicly on the internet by mistake or misuse.

So, remember that, from the license you find in this repository's `LICENSE` file:

> template-terraform-module is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even
> the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
> more details.
